!function(){"use strict";const e="https://stepsandstories.it.sparcproperties.com/api/availability";let t=null,n=null,o={},a=null,r=null;function i(){const e=document.getElementById("BuyNowButton");if(!e)return console.log("BuyNowButton not found, retrying in 1 second..."),void setTimeout(i,1e3);r=function(){const e=["h1.product__title",".product__title","h1.product-single__title",".product-single__title",'h1[itemprop="name"]',"[data-product-title]","h1"];for(const t of e){const e=document.querySelector(t);if(e&&e.textContent)return e.textContent.trim()}return null}(),console.log("Detected product name:",r),e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed",function(){const e=document.getElementById("AddToCart");if(e){e.style.display="none",console.log("Hidden AddToCart button");const t=e.parentElement;t&&1===t.children.length&&(t.style.display="none")}["#AddToCartButton",'button[name="add"]:not(#BuyNowButton)','input[name="add"]:not(#BuyNowButton)','button[type="submit"]:not(#BuyNowButton)',".product-form__cart-submit:not(#BuyNowButton)",".btn--add-to-cart"].forEach(e=>{document.querySelectorAll(e).forEach(t=>{"BuyNowButton"===t.id||t.classList.contains("buy-now")||(t.style.display="none",console.log("Hidden button:",e))})}),new MutationObserver(e=>{const t=document.getElementById("AddToCart");t&&"none"!==t.style.display&&(t.style.display="none",console.log("Hidden dynamically loaded AddToCart button"))}).observe(document.body,{childList:!0,subtree:!0})}(),function(){const e=document.getElementById("Quantity");if(e){e.value="1",e.style.display="none";const t=e.closest(".product-form__quantity")||e.closest(".quantity-selector")||e.closest(".quantity")||e.closest("quantity-input");t&&(t.style.display="none");const n=document.querySelector('label[for="Quantity"]');n&&(n.style.display="none"),console.log("Hidden quantity input and set to 1")}document.querySelectorAll("quantity-input").forEach(e=>{e.style.display="none";const t=e.querySelector('input[name="quantity"]');t&&(t.value="1")}),document.querySelectorAll(".quantity-button, .quantity__button, [data-quantity-button]").forEach(e=>{e.style.display="none"}),new MutationObserver(e=>{const t=document.getElementById("Quantity");if(t&&"none"!==t.style.display){t.value="1",t.style.display="none";const e=t.closest(".product-form__quantity")||t.closest(".quantity-selector")||t.closest(".quantity")||t.closest("quantity-input");e&&(e.style.display="none"),console.log("Hidden dynamically loaded quantity input")}document.querySelectorAll("quantity-input").forEach(e=>{if("none"!==e.style.display){e.style.display="none";const t=e.querySelector('input[name="quantity"]');t&&(t.value="1"),console.log("Hidden dynamically loaded quantity-input element")}}),document.querySelectorAll('.quantity__button:not([style*="display: none"])').forEach(e=>{e.style.display="none"})}).observe(document.body,{childList:!0,subtree:!0})}(),function(e){const t=document.createElement("div");t.id="booking-widget",t.innerHTML='\n            <div class="booking-widget-container">\n                <div class="booking-step" id="date-selection">\n                    <div id="calendar-container">\n                        <div class="calendar-header">\n                            <button id="prev-month" class="nav-button">\n                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                    <polyline points="15 18 9 12 15 6"></polyline>\n                                </svg>\n                            </button>\n                            <span id="current-month"></span>\n                            <button id="next-month" class="nav-button">\n                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                    <polyline points="9 18 15 12 9 6"></polyline>\n                                </svg>\n                            </button>\n                        </div>\n                        <div id="calendar-grid"></div>\n                    </div>\n                    <div id="availability-loading" class="loading-indicator" style="display: none;">\n                        <div class="spinner"></div>\n                        <div>Checking availability...</div>\n                    </div>\n                </div>\n                \n                <div class="booking-step" id="time-selection" style="display: none;">\n                    <div id="time-slots"></div>\n                    <button id="change-date" class="secondary-button">\n                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                            <polyline points="15 18 9 12 15 6"></polyline>\n                        </svg>\n                        Change Date\n                    </button>\n                </div>\n                \n                <div class="booking-summary" id="booking-summary" style="display: none;">\n                    <div class="summary-content">\n                        <strong>Selected Booking:</strong>\n                        <div id="selected-booking-details"></div>\n                    </div>\n                </div>\n            </div>\n        ',e.parentNode.insertBefore(t,e),function(){const e=new Date,t=new Date(e);t.setDate(e.getDate()+1),s(t)}(),document.getElementById("prev-month").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t=document.getElementById("current-month").textContent,[n,o]=t.split(" "),a=["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(n);s(new Date(parseInt(o),a-1,1))}),document.getElementById("next-month").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t=document.getElementById("current-month").textContent,[n,o]=t.split(" "),a=["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(n);s(new Date(parseInt(o),a+1,1))}),document.getElementById("change-date").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),document.getElementById("time-selection").style.display="none",document.getElementById("date-selection").style.display="block",n=null,c(),document.getElementById("booking-summary").style.display="none"})}(e),function(){const e=document.createElement("style");e.textContent="\n            .booking-widget-container {\n                background: #ffffff;\n                border: none;\n                border-radius: 12px;\n                padding: 32px;\n                margin: 24px 0;\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;\n                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n            }\n            \n            .booking-step {\n                padding-top: 0;\n            }\n            \n            .calendar-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                margin-bottom: 28px;\n            }\n            \n            .nav-button {\n                background: transparent;\n                color: #1a1a1a;\n                border: none;\n                padding: 8px;\n                border-radius: 8px;\n                cursor: pointer;\n                font-size: 20px;\n                transition: all 0.2s ease;\n                width: 36px;\n                height: 36px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            \n            .nav-button:hover {\n                background: #f5f5f5;\n            }\n            \n            #current-month {\n                font-weight: 600;\n                font-size: 18px;\n                color: #1a1a1a;\n            }\n            \n            .calendar-row {\n                display: grid;\n                grid-template-columns: repeat(7, 1fr);\n                gap: 4px;\n                margin-bottom: 4px;\n            }\n            \n            .calendar-day-header {\n                text-align: center;\n                font-weight: 600;\n                padding: 12px 4px;\n                font-size: 12px;\n                color: #666;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n            }\n            \n            .calendar-day {\n                text-align: center;\n                padding: 0;\n                background: transparent;\n                cursor: pointer;\n                min-height: 40px;\n                height: 40px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 14px;\n                color: #1a1a1a;\n                transition: all 0.15s ease;\n                border-radius: 8px;\n                position: relative;\n                font-weight: 500;\n            }\n            \n            .calendar-day.other-month {\n                color: #ccc;\n                cursor: default;\n            }\n            \n            .calendar-day.disabled {\n                color: #ccc;\n                cursor: not-allowed;\n            }\n            \n            .calendar-day.loading-availability {\n                color: #999;\n                cursor: wait;\n                opacity: 0.6;\n            }\n            \n            .calendar-day.has-availability {\n                color: #333;\n                font-weight: normal;\n            }\n            \n            .calendar-day.has-availability:hover {\n                background: #f5f5f5;\n                cursor: pointer;\n            }\n            \n            .calendar-day.fully-booked {\n                color: #ccc;\n                cursor: not-allowed;\n                text-decoration: line-through;\n            }\n            \n            .calendar-day.closed-day {\n                color: #ccc;\n                cursor: not-allowed;\n                /* No strikethrough for closed days */\n            }\n            \n            .calendar-day.selected {\n                background: #ff6b35 !important;\n                color: white;\n                font-weight: 600;\n            }\n            \n            #time-slots {\n                display: flex;\n                flex-direction: column;\n                gap: 24px;\n                margin: 24px 0;\n            }\n            \n            .time-period-section {\n                margin-bottom: 20px;\n            }\n            \n            .time-period-header {\n                margin-bottom: 16px;\n                padding-bottom: 8px;\n                border-bottom: 2px solid #f3f4f6;\n            }\n            \n            .time-period-label {\n                font-size: 14px;\n                font-weight: 600;\n                color: #6b7280;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n            }\n            \n            .time-slots-grid {\n                display: grid;\n                grid-template-columns: repeat(4, 1fr);\n                gap: 8px;\n            }\n            \n            .time-slot {\n                padding: 10px 8px;\n                border: 2px solid #e5e7eb;\n                background: white;\n                border-radius: 8px;\n                cursor: pointer;\n                font-size: 13px;\n                font-weight: 500;\n                transition: all 0.15s ease;\n                text-align: center;\n                color: #1a1a1a;\n            }\n            \n            .time-slot.available:hover {\n                border-color: #ff6b35;\n                background: #ffede6;\n                transform: translateY(-2px);\n                box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);\n            }\n            \n            .time-slot.selected {\n                background: #ff6b35;\n                color: white;\n                border-color: #ff6b35;\n                box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);\n            }\n            \n            .time-slot.booked {\n                background: #f9fafb;\n                color: #9ca3af;\n                cursor: not-allowed;\n                border-color: #e5e7eb;\n                opacity: 0.6;\n            }\n            \n            @media (max-width: 640px) {\n                .time-slots-grid {\n                    grid-template-columns: repeat(3, 1fr);\n                    gap: 6px;\n                }\n                \n                .time-slot {\n                    padding: 10px 8px;\n                    font-size: 13px;\n                }\n            }\n            \n            .secondary-button {\n                background: transparent;\n                color: #6b7280;\n                border: none;\n                padding: 12px 24px;\n                border-radius: 8px;\n                cursor: pointer;\n                margin-top: 20px;\n                font-size: 14px;\n                font-weight: 500;\n                transition: all 0.15s ease;\n                display: inline-flex;\n                align-items: center;\n                gap: 8px;\n            }\n            \n            .secondary-button:hover {\n                background: #f5f5f5;\n                color: #1a1a1a;\n            }\n            \n            .booking-summary {\n                background: #fff5f0;\n                border: 2px solid #ff6b35;\n                border-radius: 10px;\n                padding: 20px;\n                margin-top: 24px;\n            }\n            \n            .booking-detail {\n                margin: 8px 0;\n                font-size: 16px;\n                color: #1a1a1a;\n                font-weight: 500;\n            }\n            \n            .loading-indicator, .loading, .error, .no-slots {\n                text-align: center;\n                padding: 20px;\n                color: #999;\n                font-size: 14px;\n            }\n            \n            .loading-indicator {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 12px;\n                padding: 30px;\n            }\n            \n            .spinner {\n                width: 32px;\n                height: 32px;\n                border: 3px solid #f3f3f3;\n                border-top: 3px solid #ff6b35;\n                border-radius: 50%;\n                animation: spin 1s linear infinite;\n            }\n            \n            @keyframes spin {\n                0% { transform: rotate(0deg); }\n                100% { transform: rotate(360deg); }\n            }\n            \n            .error {\n                color: #d32f2f;\n            }\n            \n            #BuyNowButton {\n                position: relative;\n            }\n            \n            /* Calendar grid styling */\n            #calendar-grid {\n                border: none;\n                border-radius: 12px;\n                overflow: visible;\n                background: transparent;\n            }\n            \n            /* Modern calendar header styling */\n            .calendar-header-row {\n                margin-bottom: 16px;\n            }\n            \n            /* Prevent form submission from widget clicks */\n            #booking-widget button:not(#BuyNowButton) {\n                type: button !important;\n            }\n        ",document.head.appendChild(e)}(),setTimeout(()=>c(),100)}function s(t){const n=document.getElementById("current-month"),i=document.getElementById("calendar-grid");n.textContent=`${["January","February","March","April","May","June","July","August","September","October","November","December"][t.getMonth()]} ${t.getFullYear()}`,i.innerHTML="";const s=document.createElement("div");s.className="calendar-row calendar-header-row",["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(e=>{const t=document.createElement("div");t.className="calendar-day-header",t.textContent=e,s.appendChild(t)}),i.appendChild(s);const d=new Date(t.getFullYear(),t.getMonth(),1),c=new Date(t.getFullYear(),t.getMonth()+1,0),u=new Date(d);u.setDate(u.getDate()-d.getDay());const p=new Date,m=new Date(p);m.setDate(p.getDate()+1);let y=new Date(u);for(;y<=c||0!==y.getDay();){const e=document.createElement("div");e.className="calendar-row";for(let n=0;n<7;n++){const n=document.createElement("div");n.className="calendar-day";const o=y.getMonth()===t.getMonth(),a=new Date(y.getFullYear(),y.getMonth(),y.getDate())<new Date(m.getFullYear(),m.getMonth(),m.getDate()),r=y>new Date(p.getFullYear(),p.getMonth(),p.getDate()+365);o||n.classList.add("other-month"),a||r?(n.classList.add("disabled"),n.classList.add("permanently-disabled")):(n.classList.add("disabled"),n.classList.add("loading-availability"),n.dataset.potentiallyAvailable="true"),n.textContent=y.getDate();const i=`${y.getFullYear()}-${String(y.getMonth()+1).padStart(2,"0")}-${String(y.getDate()).padStart(2,"0")}`;n.dataset.date=i;const s=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][y.getDay()];n.title=`${i} (${s})`,e.appendChild(n),y.setDate(y.getDate()+1)}i.appendChild(e)}!async function(t){const n=document.getElementById("availability-loading");n.style.display="block";try{const n=new Date(t.getFullYear(),t.getMonth(),1);n.setDate(n.getDate()-7);const i=new Date(t.getFullYear(),t.getMonth()+1,0);i.setDate(i.getDate()+7);const s=new URL(e);s.searchParams.append("start",n.toISOString().split("T")[0]),s.searchParams.append("end",i.toISOString().split("T")[0]),r&&s.searchParams.append("product",r);const d=await fetch(s.toString()),c=await d.json();c.businessHours&&(a=c.businessHours,console.log("Stored business hours from month view:",a)),document.querySelectorAll('[data-potentially-available="true"]').forEach(e=>{e.classList.remove("disabled"),e.classList.remove("loading-availability"),e.classList.add("available-date");const t=e.dataset.date,[n,o,a]=t.split("-").map(Number),r=new Date(n,o-1,a);e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),l(r)})}),c.dates.forEach(e=>{const t=document.querySelector(`[data-date="${e.date}"]`);if(t&&t.classList.contains("available-date")){const[n,o,r]=e.date.split("-").map(Number),i=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][new Date(n,o-1,r).getDay()];console.log(`Processing ${e.date} (${i}): available=${e.available}, slots=${e.slots?.length||0}`),e.available&&e.slots&&e.slots.length>0?t.classList.add("has-availability"):(!e.available||e.slots&&0===e.slots.length)&&(0===(a[i]||[]).length?(t.classList.remove("available-date"),t.classList.add("disabled"),t.classList.add("closed-day"),t.replaceWith(t.cloneNode(!0))):(t.classList.remove("available-date"),t.classList.add("disabled"),t.classList.add("fully-booked"),t.replaceWith(t.cloneNode(!0))))}}),c.dates.forEach(e=>{o[e.date]=e.slots})}catch(e){console.error("Error loading availability:",e),document.querySelectorAll('[data-potentially-available="true"]').forEach(e=>{e.classList.remove("disabled"),e.classList.remove("loading-availability"),e.classList.add("available-date"),e.classList.add("has-availability");const t=e.dataset.date,[n,o,a]=t.split("-").map(Number),r=new Date(n,o-1,a);e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),l(r)})})}n.style.display="none"}(t)}async function l(i){const s=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`;t=s,document.querySelectorAll(".calendar-day").forEach(e=>{e.classList.remove("selected")});const l=document.querySelector(`[data-date="${s}"]`);l&&l.classList.add("selected"),await async function(i){const s=document.getElementById("time-slots");s.innerHTML='<div class="loading">Loading available times...</div>';try{const l=i.getFullYear(),c=`${l}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`;let u=o[c];if(!u||!a){console.log("Fetching availability for date:",c);const t=new URL(e);t.searchParams.append("date",c),r&&t.searchParams.append("product",r);const n=await fetch(t.toString()),o=await n.json();console.log("API response:",o),u=o.slots||[],o.businessHours&&(a=o.businessHours,console.log("Loaded business hours from API:",a))}const p=i.toLocaleDateString("en-US",{weekday:"long"});if(!a)return console.error("Business hours not loaded! This should not happen."),void(s.innerHTML='<div class="error">Error: Business hours not loaded. Please refresh and try again.</div>');const m=a[p]||[];if(console.log(`Time slots for ${p}:`,m),0===m.length)return void(s.innerHTML='<div class="no-slots">Sorry, we\'re closed on this day.</div>');const y={morning:[],afternoon:[],evening:[]};m.forEach(e=>{const t=parseInt(e.split(":")[0]),n=e.includes("PM"),o=n&&12!==t?t+12:12!==t||n?t:0;o<12?y.morning.push(e):o<17?y.afternoon.push(e):y.evening.push(e)}),s.innerHTML="";let g=!1;const h=e=>{const o=document.createElement("button");return o.className="time-slot",o.textContent=e,!u||u.includes(e)?(g=!0,o.classList.add("available"),o.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),function(e,o){n=e,document.querySelectorAll(".time-slot").forEach(e=>{e.classList.remove("selected")}),o&&o.target&&o.target.classList.add("selected"),function(){const e=document.getElementById("booking-summary"),o=document.getElementById("selected-booking-details");if(t&&n){const a=new Date(t).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"});o.innerHTML=`\n                <div class="booking-detail">${a}</div>\n                <div class="booking-detail">${n}</div>\n            `,e.style.display="block",d()}}(),function(){if(t&&n){const e=document.getElementById("BuyNowButton");if(e){e.disabled=!1,e.removeAttribute("disabled"),e.style.opacity="1",e.style.cursor="pointer",e.style.pointerEvents="auto";const t=e.type;e.type="button",e.addEventListener("click",function n(o){o.preventDefault(),o.stopPropagation(),e.classList.add("btn--loading"),e.disabled=!0,console.log("Intercepting Buy Now to clear cart first..."),d(),fetch("/new_cart",{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(e=>e.json()).then(o=>{const a=o.cart||o;if(a&&a.items&&a.items.length>0){console.log("Found "+a.items.length+" items in cart, removing them..."),a.items.length;let r=!0;function i(){fetch("/new_cart",{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(e=>e.json()).then(o=>{const a=o.cart||o,r=a.items?a.items.length:0;console.log("Cart verification - remaining items:",r),e.classList.remove("btn--loading"),e.disabled=!1,e.removeEventListener("click",n),e.type=t,setTimeout(()=>{console.log("Triggering original Buy Now..."),window.jQuery?window.jQuery("#BuyNowButton").click():e.click(),setTimeout(()=>{e.type="button",e.addEventListener("click",n)},3e3)},1e3)}).catch(o=>{console.error("Error verifying cart:",o),e.classList.remove("btn--loading"),e.disabled=!1,e.removeEventListener("click",n),e.type=t,setTimeout(()=>{window.jQuery?window.jQuery("#BuyNowButton").click():e.click()},500)})}const s=a.items.map(e=>{const t=e.variant_id||e.variant&&e.variant.id;return fetch("/cart/remove_item_quantity",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({variant_id:t.toString(),item_id:e.id.toString(),quantity:e.quantity.toString()})}).then(e=>e.json()).then(t=>(console.log(`Removed item ${e.id}`),!0)).catch(e=>(console.error("Error removing item:",e),r=!1,!1))});Promise.all(s).then(e=>{console.log("All removal requests completed"),setTimeout(i,500)})}else console.log("Cart is empty, proceeding with Buy Now..."),e.classList.remove("btn--loading"),e.disabled=!1,e.removeEventListener("click",n),e.type=t,window.jQuery?window.jQuery("#BuyNowButton").click():e.click(),setTimeout(()=>{e.type="button",e.addEventListener("click",n)},2e3)}).catch(o=>{console.error("Error retrieving cart:",o),e.classList.remove("btn--loading"),e.disabled=!1,e.removeEventListener("click",n),e.type=t,window.jQuery?window.jQuery("#BuyNowButton").click():e.click()})})}}}()}(e,o)})):(o.classList.add("booked"),o.disabled=!0),o};if([{key:"morning",label:"Morning",icon:"🌅"},{key:"afternoon",label:"Afternoon",icon:"☀️"},{key:"evening",label:"Evening",icon:"🌆"}].forEach(e=>{const t=y[e.key];if(t.length>0){const n=document.createElement("div");n.className="time-period-section";const o=document.createElement("div");o.className="time-period-header",o.innerHTML=`<span class="time-period-label">${e.label}</span>`,n.appendChild(o);const a=document.createElement("div");a.className="time-slots-grid",t.forEach(e=>{a.appendChild(h(e))}),n.appendChild(a),s.appendChild(n)}}),!g){const e=document.createElement("div");e.className="no-slots",e.textContent="Sorry, no time slots available on this date.",s.appendChild(e)}}catch(e){console.error("Error loading time slots:",e),s.innerHTML='<div class="error">Error loading times. Please try again.</div>'}}(i),document.getElementById("date-selection").style.display="none",document.getElementById("time-selection").style.display="block"}function d(){const e=document.getElementById("BuyNowButton")?.closest("form");if(!e)return;let o=e.querySelector('input[name="properties[Booking Date]"]'),a=e.querySelector('input[name="properties[Booking Time]"]'),i=e.querySelector('input[name="properties[Booking Product]"]');o||(o=document.createElement("input"),o.type="hidden",o.name="properties[Booking Date]",e.appendChild(o)),a||(a=document.createElement("input"),a.type="hidden",a.name="properties[Booking Time]",e.appendChild(a)),!i&&r&&(i=document.createElement("input"),i.type="hidden",i.name="properties[Booking Product]",e.appendChild(i)),o.value=t,a.value=n,i&&r&&(i.value=r)}function c(){const e=document.getElementById("BuyNowButton");e&&(e.disabled=!0,e.setAttribute("disabled","disabled"),e.style.opacity="0.5",e.style.cursor="not-allowed",e.style.pointerEvents="none",e.onclick=function(e){if(!t||!n)return e.preventDefault(),e.stopPropagation(),!1})}const u={init(){this.shouldDetectPayment()&&(console.log("[PaymentDetector] Order success page detected, initiating sync..."),this.detectAndSync())},shouldDetectPayment(){const e=this.isOrderSuccessPage(),t=!this.hasAlreadyTriggered();return console.log("[PaymentDetector] Success page:",e,"Not triggered:",t),e&&t},isOrderSuccessPage(){const e=window.location.pathname,t=new URLSearchParams(window.location.search),n=e.includes("/orders/"),o="sf_gateway_return"===t.get("payment_type"),a=document.querySelector("h1")?.textContent?.toLowerCase().includes("thank")||document.querySelector("h2")?.textContent?.toLowerCase().includes("thank"),r=Array.from(document.querySelectorAll("*")).some(e=>e.textContent?.includes("Order Number:")||e.textContent?.includes("Order #"));return n&&(o||a||r)},hasAlreadyTriggered(){const e=this.extractOrderId();return!!e&&"true"===sessionStorage.getItem(`sync_triggered_${e}`)},extractOrderId(){const e=this.extractNumericOrderId();if(e)return console.log("[PaymentDetector] Found numeric order ID:",e),e;const t=window.location.pathname.match(/\/orders\/([a-zA-Z0-9-]+)/),n=t?t[1]:null;return console.warn("[PaymentDetector] Could not find numeric order ID, using URL ID:",n),console.log("[PaymentDetector] This may cause API errors. Check the page for numeric order ID."),n},extractOrderNumber(){const e=[/Order #(\d+)/,/Order Number:\s*(\d+)/,/#(\d+)/],t=document.body.innerText;for(const n of e){const e=t.match(n);if(e)return e[1]}return null},extractUrlId(){const e=window.location.pathname.match(/\/orders\/([a-zA-Z0-9-]+)/);return e?e[1]:null},extractNumericOrderId(){const e=document.querySelector('meta[property="order:id"]')?.content;if(e&&/^\d+$/.test(e))return e;const t=document.querySelector("[data-order-id]")?.getAttribute("data-order-id");if(t&&/^\d+$/.test(t))return t;const n=document.querySelectorAll("script");for(const e of n){const t=e.textContent,n=[/order_id['":\s]+(\d+)/i,/"id"[:\s]+(\d+)/,/orderId['":\s]+(\d+)/i];for(const e of n){const n=t.match(e);if(n)return n[1]}}return this.extractOrderNumber()||null},extractOrderData(){const e=this.extractOrderId(),t=this.extractOrderNumber();if(!e)return console.error("[PaymentDetector] Could not extract order ID from URL"),null;const n=this.extractBookingDetails(),o={orderId:e,orderNumber:t?`#${t}`:null,timestamp:(new Date).toISOString(),pageUrl:window.location.href,source:"frontend-detection",urlId:this.extractUrlId()};return n&&(o.bookingDetails=n),console.log("[PaymentDetector] Extracted order data:",o),o},extractBookingDetails(){const e={},t=[/Booking Date[:\s]+([^\n,]+)/i,/Date[:\s]+([^\n,]+)/i,/Appointment[:\s]+([^\n,]+)/i],n=[/Booking Time[:\s]+([^\n,]+)/i,/Time[:\s]+([^\n,]+)/i,/Slot[:\s]+([^\n,]+)/i],o=document.body.innerText;for(const n of t){const t=o.match(n);if(t){e.date=t[1].trim();break}}for(const t of n){const n=o.match(t);if(n){e.time=n[1].trim();break}}return Object.keys(e).length>0?e:null},async detectAndSync(){console.log("[PaymentDetector] Page URL:",window.location.href),console.log("[PaymentDetector] Page title:",document.title);const e=document.body.innerText.match(/Order #\d+|#\d+/);e&&console.log("[PaymentDetector] Found order reference in page:",e[0]);const t=this.extractOrderData();if(t)try{await this.triggerSync(t),this.markAsTriggered(t.orderId),console.log("[PaymentDetector] Sync triggered successfully for order:",t.orderId)}catch(e){console.error("[PaymentDetector] Failed to trigger sync:",e)}else console.error("[PaymentDetector] Could not extract order data")},async triggerSync(e){const t="https://stepsandstories.it.sparcproperties.com/api/sync-order";console.log("[PaymentDetector] Triggering sync to:",t);const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json","X-Source":"frontend-detection","x-api-key":"aajE%991"},body:JSON.stringify(e)});if(!n.ok){const e=await n.text();throw new Error(`Sync failed: ${n.status} ${n.statusText} - ${e}`)}const o=await n.json();return console.log("[PaymentDetector] Sync response:",o),this.showSyncStatus(o),o},showSyncStatus(e){if(e.success&&e.events&&e.events.length>0){const t=e.events[0];console.log("[PaymentDetector] Calendar event created:",t.calendarEventLink)}},markAsTriggered(e){sessionStorage.setItem(`sync_triggered_${e}`,"true"),console.log("[PaymentDetector] Marked order as synced:",e)}},p={init(){this.isCheckoutPage()&&(console.log("[CheckoutModifier] Checkout page detected, applying modifications..."),this.modifyPickupOptions(),this.hidePickupSection())},isCheckoutPage(){const e=window.location.pathname;return e.includes("/checkout/")||e.includes("/sf/checkout/")},modifyPickupOptions(){const e=document.querySelector('input[name="checkout[pickup_address][is_self_collect]"][value="true"]');e&&(e.checked=!0,console.log("[CheckoutModifier] Self collect option selected")),document.querySelectorAll('input[name="checkout[pickup_address][is_self_collect]"]').forEach(e=>{let t=e.closest(".card");t&&(t.style.display="none",console.log("[CheckoutModifier] Pickup options card hidden"))})},hidePickupSection(){const e=document.getElementById("pickup-section");e&&(e.style.display="none",console.log("[CheckoutModifier] Pickup section hidden"));const t=document.querySelector(".receiver-section");t&&(t.style.display="none",console.log("[CheckoutModifier] Receiver section hidden")),document.querySelectorAll('[id*="pickup"], .pickup-section, [class*="pickup-section"]').forEach(e=>{e.querySelector('input[name*="pickup"]')&&(e.style.display="none",console.log("[CheckoutModifier] Additional pickup section hidden"))}),document.querySelectorAll('.receiver-form, [class*="receiver"]').forEach(e=>{e.querySelector('input[name*="receiver"]')&&(e.style.display="none",console.log("[CheckoutModifier] Additional receiver form hidden"))})},observeChanges(){new MutationObserver(()=>{this.modifyPickupOptions(),this.hidePickupSection()}).observe(document.body,{childList:!0,subtree:!0})}},m={init(){this.isHomePage()&&(console.log("[VideoReplacer] Homepage detected, replacing YouTube video..."),this.replaceVideo(),this.observeForVideoSection())},isHomePage(){const e=window.location.pathname;return"/"===e||""===e||"/index"===e||"/home"===e},replaceVideo(){const e=document.querySelector(".video-bg-section");if(!e)return void console.log("[VideoReplacer] Video section not found yet");const t=e.querySelector("deferred-media");if(!t)return void console.log("[VideoReplacer] Deferred media element not found");const n=document.createElement("div");n.className="custom-video-container",n.style.cssText="\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                overflow: hidden;\n                z-index: 0;\n            ";const o=document.createElement("video");o.muted=!0,o.playsInline=!0,o.loop=!0,o.autoplay=!0,o.setAttribute("playsinline",""),o.setAttribute("webkit-playsinline",""),o.setAttribute("muted",""),o.setAttribute("autoplay",""),o.style.cssText="\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                min-width: 100%;\n                min-height: 100%;\n            ",o.poster="https://d1y4qg1xbumuwm.cloudfront.net/cover.png",n.style.backgroundImage="url(https://d1y4qg1xbumuwm.cloudfront.net/cover.png)",n.style.backgroundSize="cover",n.style.backgroundPosition="center",n.style.backgroundRepeat="no-repeat";const a=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);if(a){const e=document.createElement("source");e.src="https://d1y4qg1xbumuwm.cloudfront.net/cover.mp4",e.type="video/mp4",o.appendChild(e)}const r=document.createElement("source");if(r.src="https://d1y4qg1xbumuwm.cloudfront.net/cover.webm",r.type="video/webm",o.appendChild(r),!a){const e=document.createElement("source");e.src="https://d1y4qg1xbumuwm.cloudfront.net/cover.mp4",e.type="video/mp4",o.appendChild(e)}o.addEventListener("loadeddata",()=>{console.log("[VideoReplacer] Video loaded successfully"),o.play().catch(e=>{console.log("[VideoReplacer] Autoplay prevented, user interaction may be required")})}),o.addEventListener("error",e=>{console.error("[VideoReplacer] Video loading error:",e),n.style.backgroundImage="url(https://d1y4qg1xbumuwm.cloudfront.net/cover.png)",n.style.backgroundSize="cover",n.style.backgroundPosition="center"}),n.appendChild(o),t.style.display="none",t.parentNode.insertBefore(n,t);const i=e.querySelector(".video-bg-wrapper");i&&(i.style.position="relative",i.style.zIndex="1"),console.log("[VideoReplacer] Video replacement complete");let s=!1;o.addEventListener("playing",()=>{console.log("[VideoReplacer] Video is playing"),s=!0,n.style.backgroundImage="none"}),o.addEventListener("pause",()=>{console.log("[VideoReplacer] Video paused"),s||(n.style.backgroundImage="url(https://d1y4qg1xbumuwm.cloudfront.net/cover.png)")}),o.addEventListener("canplaythrough",()=>{const e=o.play();void 0!==e&&e.then(()=>{console.log("[VideoReplacer] Autoplay successful")}).catch(e=>{console.log("[VideoReplacer] Autoplay failed:",e.name)})},{once:!0}),document.addEventListener("touchstart",()=>{s||o.play()},{once:!0}),document.addEventListener("click",()=>{s||o.play()},{once:!0})},observeForVideoSection(){new MutationObserver(e=>{const t=document.querySelector(".video-bg-section");t&&!t.querySelector(".custom-video-container")&&(console.log("[VideoReplacer] Video section dynamically loaded, replacing..."),this.replaceVideo())}).observe(document.body,{childList:!0,subtree:!0})}};var y;y=function(){!function(){document.querySelectorAll('meta[name="theme-color"]').forEach(e=>e.remove());const e=document.createElement("meta");e.name="theme-color",e.content="#ffffff",document.head.appendChild(e);const t=document.createElement("meta");t.name="theme-color",t.content="#000000",t.media="(prefers-color-scheme: dark)",document.head.appendChild(t),console.log("[Safari Theme] Theme color set to default")}(),m.init(),function(){const e=document.getElementById("cart-icon-bubble");e&&(e.style.display="none",console.log("Hidden cart button")),new MutationObserver(e=>{const t=document.getElementById("cart-icon-bubble");t&&"none"!==t.style.display&&(t.style.display="none",console.log("Hidden dynamically loaded cart button"))}).observe(document.body,{childList:!0,subtree:!0})}(),u.isOrderSuccessPage()||p.isCheckoutPage()||m.isHomePage()||i(),u.init(),p.init(),p.isCheckoutPage()&&p.observeChanges()},"loading"!==document.readyState?y():document.addEventListener("DOMContentLoaded",y)}();